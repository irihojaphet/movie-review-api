{% extends 'reviews/base.html' %}

{% block title %}Movies - Movie Review API{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">All Movies</h2>
        <div>
            <input type="text" id="searchInput" placeholder="Search movies..." style="padding: 0.5rem; border: 2px solid #e0e0e0; border-radius: 5px; width: 300px;">
        </div>
    </div>
    
    <div id="moviesContainer" class="grid">
        <div class="loading">Loading movies...</div>
    </div>
    
    <div id="pagination" style="text-align: center; margin-top: 2rem;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let searchQuery = '';
    
    async function loadMovies(page = 1, search = '') {
        const container = document.getElementById('moviesContainer');
        container.innerHTML = '<div class="loading">Loading movies...</div>';
        
        try {
            let url = `/movies/?page=${page}`;
            if (search) {
                url += `&search=${encodeURIComponent(search)}`;
            }
            
            const result = await apiCall(url);
            
            if (result.results && result.results.length > 0) {
                container.innerHTML = result.results.map(movie => `
                    <div class="card movie-card">
                        <h3 class="movie-title">${movie.title}</h3>
                        ${movie.genre ? `<p class="movie-genre">${movie.genre}</p>` : ''}
                        ${movie.release_year ? `<p class="movie-year">${movie.release_year}</p>` : ''}
                        ${movie.description ? `<p style="margin-top: 1rem; color: #666; font-size: 0.9rem;">${movie.description.substring(0, 100)}${movie.description.length > 100 ? '...' : ''}</p>` : ''}
                        <div style="margin-top: 1rem;">
                            <a href="/movies/${movie.id}/" class="btn btn-primary btn-small">View Details</a>
                        </div>
                    </div>
                `).join('');
                
                // Pagination
                const paginationDiv = document.getElementById('pagination');
                if (result.count > result.results.length) {
                    let paginationHTML = '';
                    if (result.previous) {
                        paginationHTML += `<button onclick="loadMovies(${page - 1}, '${search}')" class="btn btn-secondary btn-small">Previous</button> `;
                    }
                    paginationHTML += `<span style="margin: 0 1rem;">Page ${page} of ${Math.ceil(result.count / 10)}</span>`;
                    if (result.next) {
                        paginationHTML += ` <button onclick="loadMovies(${page + 1}, '${search}')" class="btn btn-secondary btn-small">Next</button>`;
                    }
                    paginationDiv.innerHTML = paginationHTML;
                } else {
                    paginationDiv.innerHTML = '';
                }
            } else {
                container.innerHTML = '<div class="empty-state"><h3>No movies found</h3><p>Try adjusting your search.</p></div>';
            }
        } catch (error) {
            container.innerHTML = `<div class="alert alert-error">Error loading movies: ${error.message}</div>`;
        }
    }
    
    document.getElementById('searchInput').addEventListener('input', (e) => {
        searchQuery = e.target.value;
        currentPage = 1;
        loadMovies(currentPage, searchQuery);
    });
    
    loadMovies();
</script>
{% endblock %}

